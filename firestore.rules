
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Default deny all access if no other rule matches.
    match /{document=**} {
      allow read, write: if false;
    }

    // Rules for 'journalEntries' collection
    match /journalEntries/{entryId} {
      // Allow a user to create an entry if authenticated,
      // and the entry includes a creatorUserId and companyId.
      // This is relaxed for server-side Genkit flows.
      allow create: if request.auth != null
                    && request.resource.data.creatorUserId != null
                    && request.resource.data.companyId != null;

      // Allow an authenticated user to read entries if the entry has a companyId.
      allow read: if request.auth != null && resource.data.companyId != null;

      // Allow a user to update or delete an entry only if they are its creator.
      allow update, delete: if request.auth != null
                             && request.auth.uid == resource.data.creatorUserId;
    }

    // Rules for 'invoices' collection
    match /invoices/{invoiceId} {
      // Allow a user to create an invoice if authenticated,
      // and the invoice includes a creatorUserId and companyId.
      // This is relaxed for server-side Genkit flows.
      allow create: if request.auth != null
                    && request.resource.data.creatorUserId != null
                    && request.resource.data.companyId != null;

      // Allow an authenticated user to read invoices if the invoice has a companyId.
      allow read: if request.auth != null && resource.data.companyId != null;

      // Allow a user to update or delete an invoice only if they are its creator.
      allow update, delete: if request.auth != null
                             && request.auth.uid == resource.data.creatorUserId;
    }

    // Rules for 'companySettings' collection
    // The document ID for these settings IS the companyId.
    match /companySettings/{companyId} {
      allow read, write: if request.auth != null;
    }

    // Rules for 'aiPreferencesSettings' collection
    // The document ID for these settings IS the companyId.
    match /aiPreferencesSettings/{companyId} {
      allow read, write: if request.auth != null;
    }

    // Rules for 'notifications' collection
    match /notifications/{notificationId} {
      allow read: if request.auth != null && resource.data.companyId != null;
      allow create: if request.auth != null && request.resource.data.companyId != null;
      allow update, delete: if false;
    }
  }
}
